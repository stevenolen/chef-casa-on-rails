# Managed by Chef for node <%= node['fqdn'] -%>.

require 'elasticsearch'

Rails.application.config.elasticsearch_client = Elasticsearch::Client.new hosts: [
  { host: '<%= @casa_es_host %>', port: <%= @casa_es_port %> }
]

Rails.application.config.elasticsearch_index = '<%= @casa_es_index %>'

begin
  Rails.application.config.elasticsearch_client.ping
  App.drop_index!
  App.where(enabled: true).each { |app| app.add_to_index! }
rescue Faraday::ConnectionFailed => e
  puts "WARNING: Could not connect to Elasticsearch"
  Rails.application.config.elasticsearch_client = nil
rescue ActiveRecord::StatementInvalid => e
  puts "WARNING: Running without initializing index"
end